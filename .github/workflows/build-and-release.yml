name: Build and Release LAN File Server

# 触发条件：
# 1. 推送带有v*标签的提交
# 2. 手动触发
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
      branch:
        description: 'Branch to build from'
        required: false
        default: 'main'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      # 2. 设置Python环境
      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'
      
      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. 安装PyInstaller和其他打包依赖
      - name: Install PyInstaller and packaging tools
        run: |
          pip install pyinstaller>=5.0.0 watchdog>=2.1.0
      
      # 5. 创建PyInstaller配置文件
      - name: Create PyInstaller spec file
        run: |
          echo "Creating PyInstaller spec file..."
          pyinstaller --name "LANFileServer" `
                     --onefile `
                     --windowed `
                     --add-data "static;static" `
                     --icon=none `
                     --hidden-import=config `
                     --hidden-import=color_logger `
                     --exclude-module=tkinter `
                     server.py
      
      # 6. 构建exe文件
      - name: Build executable
        run: |
          echo "Building executable..."
          pyinstaller LANFileServer.spec
        continue-on-error: false
      
      # 7. 验证构建输出
      - name: Verify build output
        run: |
          echo "Verifying build output..."
          if (-not (Test-Path "dist\LANFileServer.exe")) {
            Write-Error "Build failed: LANFileServer.exe not found"
            exit 1
          }
          Get-Item "dist\LANFileServer.exe" | Select-Object Name, Length, CreationTime
          $fileHash = Get-FileHash "dist\LANFileServer.exe" -Algorithm SHA256
          Write-Host "SHA256 Hash: $($fileHash.Hash)"
      
      # 8. 生成版本信息
      - name: Generate version info
        id: version_info
        run: |
          $tag = $env:GITHUB_REF_NAME
          if ([string]::IsNullOrEmpty($tag)) {
            $tag = ${{ github.event.inputs.version || 'v0.0.0' }}
          }
          echo "version=$tag" >> $env:GITHUB_OUTPUT
          echo "exe_file=dist\LANFileServer.exe" >> $env:GITHUB_OUTPUT
      
      # 9. 创建GitHub Release并上传资产
      - name: Create Release and Upload Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version_info.outputs.version }}
          name: Release ${{ steps.version_info.outputs.version }}
          body: |
            ## What's Changed
            
            - Built on ${{ runner.os }}
            - Python version: ${{ steps.setup-python.outputs.python-version }}
          artifacts: "${{ steps.version_info.outputs.exe_file }}"
          artifactContentType: "application/octet-stream"
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: ${{ contains(steps.version_info.outputs.version, 'beta') || contains(steps.version_info.outputs.version, 'alpha') }}
      
      # 10. 清理构建文件
      - name: Cleanup build files
        if: always()
        run: |
          Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "__pycache__" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "*.spec" -Force -ErrorAction SilentlyContinue
      
      # 11. 上传构建日志作为artifact
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            dist/
            LANFileServer.spec
          retention-days: 7

  # 12. 部署文档（可选）
  deploy-docs:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy documentation
        run: |
          echo "Documentation deployment would happen here"
          # 这里可以添加文档部署步骤，如部署到GitHub Pages

# 13. 工作流状态通知（可选）
# 可以添加通知步骤，如发送Slack消息或邮件通知
# - name: Send notification
#   if: always()
#   uses: 8398a7/action-slack@v3
#   with:
#     status: ${{ job.status }}
#     fields: repo,message,commit,author,action,eventName,ref,workflow,job
#   env:
#     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# 14. 构建矩阵测试（可选）
# 可以添加多版本Python和多平台测试
# strategy:
#   matrix:
#     python-version: [3.8, 3.9, 3.10, 3.11]
#     architecture: [x64, x86]

# 15. 缓存依赖（可选）
# - name: Cache dependencies
#   uses: actions/cache@v4
#   with:
#     path: ~\AppData\Local\pip\Cache
#     key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
#     restore-keys: |
#       ${{ runner.os }}-pip-
